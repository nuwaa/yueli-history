{{ define "main" }}
<main class="page single cute-article" style="max-width: 100%; width: 100%">

<!-- ğŸŒ¸ ãƒŠãƒ“ãƒãƒ¼ï¼ˆä¸Šéƒ¨ï¼‰ -->
{{ partial "nav.html" . }}

  <div class="page-header" style="text-align: center;">
    <h1 class="page-title">è³ªå•ä¸€è¦§</h1>
  </div>

  <!-- ğŸ” æ¤œç´¢ãƒãƒ¼ -->
  <div style="text-align:center; margin: 1rem auto;">
    <input type="text" id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" style="padding: 0.5rem; width: 60%; max-width: 400px; border-radius: 8px; border: 1px solid #ccc;">
  </div>

  <!-- ğŸ”€ ä¸¦ã³æ›¿ãˆ -->
  <div x-data="{ sort: 'lastmod' }" class="sort-toggle" style="text-align: center; margin-bottom: 1rem;">
    <label><input type="radio" x-model="sort" value="lastmod" checked> æ›´æ–°æ—¥é †</label>
    <label style="margin-left: 1rem;"><input type="radio" x-model="sort" value="popular"> äººæ°—é †</label>
  </div>

  <!-- âœ… è³ªå•å›ç­”ä»¶æ•°è¡¨ç¤º -->
  {{ $questions := .Pages }}
  <p style="text-align: center; font-weight: bold; color: #cc3388; margin-bottom: 1rem;">
    ç¾åœ¨ã®è³ªå•å›ç­”ä»¶æ•°ï¼š{{ len $questions }}ä»¶
  </p>

  <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
  <div class="question-cards" style="width: 100%;">
    <div class="card-container" id="cardContainer">
      {{ range .Pages.ByDate.Reverse }}
        {{ $thumb := "" }}
        {{ with .Params.thumbnail }}{{ $thumb = . }}{{ end }}
        {{ if eq $thumb "" }}{{ with .Params.cover }}{{ $thumb = . }}{{ end }}{{ end }}
        {{ if eq $thumb "" }}{{ with .Params.images }}{{ $thumb = index . 0 }}{{ end }}{{ end }}
        {{ if eq $thumb "" }}{{ with .Resources.GetMatch "*featured*" }}{{ $thumb = .RelPermalink }}{{ end }}{{ end }}

        <div class="card"
             data-title="{{ .Title | lower }}"
             data-body="{{ .Plain | lower }}"
             data-lastmod="{{ .Lastmod.Format `2006-01-02` }}"
             data-popularity="{{ .Params.views | default 0 }}"
             style="margin-bottom: 2.5rem;">
          {{ if $thumb }}
            <img src="{{ $thumb }}" alt="thumbnail" style="width: 100%; max-width: 600px; height: auto; object-fit: cover; border-radius: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); margin: 0 auto 1rem auto; display: block;">
          {{ end }}

          <div style="padding: 0 0.5rem;">
            <h3 style="font-size: 1.25rem; margin-bottom: 0.3rem;">
              <a href="{{ .RelPermalink }}">{{ .Title }}</a>
            </h3>     

            <p class="date" style="font-size: 0.85rem; color: #888;">
              {{ .Date.Format "2006å¹´01æœˆ02æ—¥" }}
            </p>
            
            {{ $plain := replace .Plain "\n" " " }}
            {{ $lines := split $plain "." }}
            {{ $summary := "" }}
            {{ range $lines }}
              {{ $line := trim . " " }}
              {{ $line = replace $line "æ—¥æœ¬èªã®è§£èª¬" "" }}
              {{ if and (eq $summary "") (ne $line "") (ne $line "1") (not (hasPrefix $line "description:")) (not (hasPrefix $line "keywords:")) (not (hasPrefix $line "{{<")) (not (hasPrefix $line "#")) }}
                {{ with $line }}{{ $summary = . }}{{ end }}
                {{ break }}
              {{ end }}
            {{ end }}

            <p style="margin-top: 0.5rem;">{{ $summary | truncate 80 }}</p>
            <a class="read-more" href="{{ .RelPermalink }}" style="color: #cc3388;">ç¶šãã‚’èª­ã‚€ â†’</a>
          </div>
        </div>
      {{ end }}
    </div>
  </div>

<!-- ğŸŒ¸ ãƒŠãƒ“ãƒãƒ¼ï¼ˆä¸‹éƒ¨ï¼‰ -->
{{ partial "nav.html" . }}

  <!-- ğŸ“¢ åºƒå‘Šã‚¨ãƒªã‚¢ -->
  <div class="cute-adsense" style="margin: 2rem 0; text-align:center;">
    <div style="font-size: 0.85rem; color: #cc88aa;">
    <!-- ğŸ“¢ åºƒå‘Šã‚¨ãƒªã‚¢ï¼ˆæº–å‚™ä¸­ï¼‰-->
    </div>
  </div>

  <!-- ğŸŒ™ è‘—ä½œæ¨©è¡¨ç¤º -->
  <footer style="text-align:center; margin-top:1rem; font-size: 0.85rem; color: #aa88aa;">
    Â© 2025 æœˆç’ƒ(Yueli) ğŸŒ™
  </footer>

  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    const searchInput = document.getElementById("searchInput");
    const cards = document.querySelectorAll(".card");
    const container = document.getElementById("cardContainer");

    function highlight(text, keyword) {
      if (!keyword) return text;
      const escaped = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const re = new RegExp(escaped, "gi");
      return text.replace(re, match => "<mark>" + match + "</mark>");
    }

    searchInput.addEventListener("input", function () {
      const keyword = this.value.toLowerCase();
      cards.forEach(card => {
        const titleElem = card.querySelector("h3");
        const titleLink = titleElem.querySelector("a");
        const bodyElem = card.querySelector("p:not(.date)");
        const rawTitle = card.getAttribute("data-title");
        const rawBody = card.getAttribute("data-body");
        const match = rawTitle.includes(keyword) || rawBody.includes(keyword);
        card.style.display = match || keyword === "" ? "block" : "none";
        titleLink.innerHTML = highlight(titleLink.textContent, keyword);
        bodyElem.innerHTML = highlight(bodyElem.textContent, keyword);
      });
    });

    document.querySelectorAll("input[type=radio][x-model='sort']").forEach(radio => {
      radio.addEventListener("change", () => {
        const selected = document.querySelector("input[type=radio][x-model='sort']:checked").value;
        const cardsArray = Array.from(container.querySelectorAll(".card"));
        cardsArray.sort((a, b) => {
          if (selected === "popular") {
            return (parseInt(b.dataset.popularity) || 0) - (parseInt(a.dataset.popularity) || 0);
          } else {
            return b.dataset.lastmod.localeCompare(a.dataset.lastmod);
          }
        });
        cardsArray.forEach(card => container.appendChild(card));
      });
    });
  </script>

</main>
{{ end }}
